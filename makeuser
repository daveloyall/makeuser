#!/bin/bash
# ---------------------------------------------------------------------------
# makeuser - tilde.team new user creation
# Usage: makeuser [-h|--help] <username> <email> "<pubkey>"
# ---------------------------------------------------------------------------

PROGNAME=${0##*/}
VERSION="0.1"

error_exit() {
  echo -e "${PROGNAME}: ${1:-"Unknown Error"}" >&2
  exit 1
}

usage() {
  echo -e "usage: $PROGNAME [-h|--help] <username> <email> \"<pubkey>\""
}

sub_to_list() {
  echo "
From: $1
Subject: subscribe
" | sudo -u $1 sendmail tildeteam-join@lists.tildeverse.org
}

case $1 in
  -h | --help)
    usage; exit ;;
  -* | --*)
    usage; error_exit "unknown option $1" ;;
  *)
    [[ $# -ne 3 ]] && error_exit "not enough args"

    echo "adding new user $1"
    newpw=$(pwgen -1B 10)
    pwcrypt=$(perl -e "print crypt('${newpw}', 'sa');")
    sudo useradd -m -g 100 -p "$pwcrypt" -s /bin/bash $1 \
        || error_exit "couldn't add user"

    echo "sending welcome mail"
    sed -e "s/newusername/$1/g" -e "s/newpassword/$newpw/" /usr/local/bin/welcome-email.tmpl \
        | sendmail $1 $2 sudoers@tilde.team

    echo "subscribing to mailing list"
    sub_to_list $1

    echo "creating znc account"
    sudo -u znc /home/znc/add_znc_user.sh $1

    echo "adding ssh pubkey"
    echo "$3" | sudo tee /home/$1/.ssh/authorized_keys

    echo "announcing new user on mastodon"
    toot "welcome new user ~$1!" ;;
esac

